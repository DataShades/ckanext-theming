{%- macro form_block() -%}
    {{ ui.form(caller(), *varargs, **kwargs) }}
{%- endmacro %}

{%- macro form(content, method, action, enctype, include_csrf=true) -%}
    {{ ui.form_start(method, action, enctype, **kwargs) }}
    {{ h.csrf_input() if include_csrf and method and method|upper != "GET" }}
    {{ content }}
    {{ ui.form_end() }}
{%- endmacro %}

{%- macro form_actions(content) -%}
    <div {{ ui.util.attrs(kwargs) }}>{{ content }}</div>
{%- endmacro %}

{%- macro form_start(method, action, enctype) -%}
    <form {{ ui.util.attrs(kwargs) }} method="{{ method }}" action="{{ action }}" enctype="{{ enctype }}">
{%- endmacro %}

{%- macro form_end() -%}
    {%- do kwargs -%}
    </form>
{%- endmacro %}

{%- macro form_errors(errors={}) -%}
    {% if errors %}
        <div>
            <p>{{ _('The form contains invalid entries:') }}</p>
            <ul>
                {% for key, error in errors.items() %}
                    <li>{% if key %}{{ key }}: {% endif %}{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
{%- endmacro %}

{%- macro field_errors(errors) -%}
    {%- if errors -%}
        {%- for error in errors -%}
            <span>{{ error }}</span><br/>
        {%- endfor %}
    {%- endif %}
{%- endmacro %}

{% macro input(content, name, id, label, value, required, placeholder, type="text", errors=[]) -%}
    {%- set id = id or "field-" ~ name if name else "" -%}

    <div>
        {%- if label and id -%}
            <label for="{{ id }}">{{ label }}</label>
        {%- endif %}
        {%- if content -%}
            <p>{{ content }}</p>
        {%- endif %}
        <input {{ ui.util.attrs(kwargs) }} name="{{ name }}" id="{{ id }}" type="{{ type }}" value="{{ value }}" {{ "required" if required }} placeholder="{{ placeholder }}" />
        {{ ui.field_errors(errors) }}
    </div>
{%- endmacro %}

{%- macro hidden_input(name, value) -%}
    <input {{ ui.util.attrs(kwargs) }} type="hidden" name="{{ name }}" value="{{ value }}">
{%- endmacro %}

{% macro checkbox(content, name, id, label, value="on", checked=false, errors=[], required=false) %}
    {%- if checked -%}
        {%- do kwargs.setdefault("attrs", {}).setdefault("checked", true) -%}
    {%- endif %}
    {{ ui.input(content, name, id=id, label=label, value=value, type="checkbox", errors=errors, required=required, **kwargs) }}
{% endmacro %}

{%- macro textarea(content, name, id, label, value, placeholder, errors=[], required=false) -%}
    {%- set id = id or "field-" ~ name if name else "" -%}

    <div>
        {%- if label and id -%}
            <label for="{{ id }}">{{ label }}</label>
        {%- endif %}
        {%- if content -%}
            <p>{{ content }}</p>
        {%- endif %}
        <textarea {{ ui.util.attrs(kwargs) }} placeholder="{{ placeholder }}" name="{{ name }}" id="{{ id }}" {{ "required" if required }}>{{ value }}</textarea>

        {{ ui.field_errors(errors) }}
    </div>
{%- endmacro %}

{%- macro submit(value, name) -%}
    {%- do kwargs.setdefault("attrs", {}).update({"value": value, "name": name}) -%}
    {{ ui.button(value, type="submit", **kwargs) }}
{%- endmacro %}

{%- macro markdown(content, name, id, label, value, placeholder, errors=[], required=false) -%}
    {%- set id = id or "field-" ~ name if name else "" -%}
    {% set popover_id = ui.util.id() %}

    <div>
        {%- if label and id -%}
            <label for="{{ id }}">{{ label }}</label>
        {%- endif %}
        {%- if content -%}
            <p>{{ content }}</p>
        {%- endif %}

        <textarea {{ ui.util.attrs(kwargs) }} placeholder="{{ placeholder }}" name="{{ name }}" id="{{ id }}" {{ "required" if required }}>{{ value }}</textarea>

        {%- call ui.util.call(ui.popover_content, title=_("Markdown formatting"), id=popover_id) -%}
            <p>__Bold text__ or _italic text_</p>
            <p># title
                <br>## secondary title
                <br>### etc
            </p>
            <p>* list
                <br>* of
                <br>* items
            </p>
            <p>http://auto.link.ed/</p>
            <p>
                <strong>
                    <a href='http://daringfireball.net/projects/markdown/syntax' target='_blank'>Full markdown syntax</a>
                </strong>
            </p>
            <p>
                <strong>Please note:</strong>
                HTML tags are stripped out for security reasons
            </p>
        {%- endcall -%}

        <span>
            You can use {{ ui.popover_handler(_("Markdown formatting"), id=popover_id) }} here
        </span>

        {{ ui.field_errors(errors) }}
    </div>

{%- endmacro %}

{%- macro select_block(content, name, id, label, multiple, errors=[], required=false) -%}
    {%- set id = id or "field-" ~ name if name else "" -%}
    <div>
        {%- if label -%}
            <label for="{{ id }}">{{ label }}</label>
        {%- endif %}
        {%- if content -%}
            <p>{{ content }}</p>
        {%- endif %}

        <select {{ ui.util.attrs(kwargs) }} name="{{ name }}" id="{{ id }}" {{ "required" if required }} {{ "multiple" if multiple }}>
            {{ caller() }}
        </select>

        {{ ui.field_errors(errors) }}
    </div>
{%- endmacro %}

{%- macro select(content, name, id, label, selected, multiple, options=[], errors=[], required=false) -%}
    {% set selected = selected if value is not string and value is iterable else [selected] %}

    {%- call ui.select_block(content=content, name=name, id=id, label=label, selected=selected, multiple=multiple, options=options, errors=errors, required=required, **kwargs) -%}
        {%- for option in options %}
            {%- if option is string %}
                {% set value, text = option, option %}

            {%- else -%}
                {% set value = option.value %}
                {% set text = option.text or option.value %}

            {%- endif %}

            <option value="{{ value }}" {{ "selected" if value in selected }}>{{ text }}</option>
        {%- endfor %}

    {%- endcall %}
{%- endmacro %}

{%- macro radio(content, name, id, label="", value="on", checked=false, errors=[], required=false) -%}
    {%- set id = id or "field-" ~ name if name else "" -%}

    {%- if content -%}
        <p>{{ content }}</p>
    {%- endif %}
    <input {{ ui.util.attrs(kwargs) }} type="radio" name="{{ name }}" id="{{ id }}" value="{{ value }}" {{ "checked" if checked }} {{ "required" if required }} />

    {%- if label -%}
        <label for="{{ id }}">{{ label }}</label>
    {%- endif %}

    {{ ui.field_errors(errors) }}
{%- endmacro %}

{%- macro file_input(content, name, id, label="", errors=[], required=false) -%}
    {%- set id = id or "field-" ~ name if name else "" -%}

    {%- if content -%}
        <p>{{ content }}</p>
    {%- endif %}
    {%- if label -%}
        <label for="{{ id }}">{{ label }}</label>
    {%- endif %}

    <input {{ ui.util.attrs(kwargs) }} type="file" name="{{ name }}" id="{{ id }}" {{ "required" if required }}/>

    {{ ui.field_errors(errors) }}
{%- endmacro %}

{%- macro range_input(content, name, id, label="", value=0, min=0, max=100, errors=[], required=false) -%}
    {%- set id = id or "field-" ~ name if name else "" -%}

    {%- if content -%}
        <p>{{ content }}</p>
    {%- endif %}
    {%- if label -%}
        <label for="{{ id }}">{{ label }}</label>
    {%- endif %}

    <input {{ ui.util.attrs(kwargs) }} type="range" name="{{ name }}" id="{{ id }}" value="{{ value }}" min="{{ min }}" max="{{ max }}" {{ "required" if required }}/>

    {{ ui.field_errors(errors) }}
{%- endmacro %}

{%- macro toggle_switch(content, name, id, label="", value="on", checked=false, errors=[], required=false) -%}
    {%- set id = id or "field-" ~ name if name else "" -%}

    {%- if content -%}
        <p>{{ content }}</p>
    {%- endif %}
    <div class="toggle-switch">
        <input {{ ui.util.attrs(kwargs) }} type="checkbox" name="{{ name }}" id="{{ id }}" value="{{ value }}" {{ "checked" if checked }} {{ "required" if required }}>
        <label for="{{ id }}">{{ label }}</label>
    </div>

    {{ ui.field_errors(errors) }}
{%- endmacro %}
